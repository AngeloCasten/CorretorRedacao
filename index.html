<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Escolar</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; padding: 20px; }
input, textarea, select { display:block; margin: 10px 0; width: 100%; max-width:400px; }
button { margin-top:10px; }
.card { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
</style>
</head>
<body>
<h1>Sistema Escolar</h1>

<h2>Cadastro</h2>
<input type="text" id="cad_nome" placeholder="Nome">
<input type="email" id="cad_email" placeholder="Email">
<input type="password" id="cad_senha" placeholder="Senha">
<select id="cad_tipo">
  <option value="aluno">Aluno</option>
  <option value="professor">Professor</option>
</select>
<input type="number" id="cad_turma" placeholder="ID Turma (opcional)">
<button onclick="cadastro()">Cadastrar</button>

<h2>Login</h2>
<input type="email" id="login_email" placeholder="Email">
<input type="password" id="login_senha" placeholder="Senha">
<button onclick="login()">Entrar</button>

<h2>Área do Usuário</h2>
<div id="user_area"></div>

<script>
let user = null;
let tipo = null;

async function cadastro(){
    const res = await fetch('/cadastro', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            nome: document.getElementById('cad_nome').value,
            email: document.getElementById('cad_email').value,
            senha: document.getElementById('cad_senha').value,
            tipo: document.getElementById('cad_tipo').value,
            id_turma: document.getElementById('cad_turma').value || null
        })
    });
    alert((await res.json()).message);
}

async function login(){
    const res = await fetch('/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            email: document.getElementById('login_email').value,
            senha: document.getElementById('login_senha').value
        })
    });
    const data = await res.json();
    if(data.error) { alert(data.error); return; }
    user = data.id;
    tipo = data.tipo;
    document.getElementById('user_area').innerHTML = '<b>Logado como '+tipo+'</b>';
    carregarArea();
}

async function carregarArea(){
    if(tipo==='aluno'){
        const res = await fetch('/temas');
        const temas = await res.json();
        let html = '<h3>Temas da sua turma</h3>';
        temas.forEach(t => {
            html += `<div class="card">
                        <b>${t.titulo}</b><p>${t.descricao}</p>
                        <textarea id="texto_${t.id}" placeholder="Sua redação aqui"></textarea>
                        <button onclick="enviarRedacao(${t.id})">Enviar Redação</button>
                     </div>`;
        });
        document.getElementById('user_area').innerHTML += html;
    } else if(tipo==='professor'){
        const res = await fetch('/redacoes');
        const redacoes = await res.json();
        let html = '<h3>Redações recebidas</h3>';
        redacoes.forEach(r => {
            html += `<div class="card">
                        <b>ID: ${r.id} | Aluno: ${r.id_aluno} | Tema: ${r.id_tema}</b>
                        <p>${r.texto}</p>
                        <input type="number" id="nota_${r.id}" placeholder="Nota">
                        <input type="text" id="avaliacao_${r.id}" placeholder="Comentário">
                        <button onclick="avaliar(${r.id})">Avaliar</button>
                     </div>`;
        });
        document.getElementById('user_area').innerHTML += html;
    }
}

async function enviarRedacao(id_tema){
    const texto = document.getElementById('texto_'+id_tema).value;
    const res = await fetch('/redacao/enviar',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id_tema, texto})
    });
    alert((await res.json()).message);
}

async function avaliar(id){
    const nota = document.getElementById('nota_'+id).value;
    const avaliacao = document.getElementById('avaliacao_'+id).value;
    const res = await fetch('/redacao/avaliar/'+id,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({nota, avaliacao})
    });
    alert((await res.json()).message);
}
</script>
</body>
</html>
